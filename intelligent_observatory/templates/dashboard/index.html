{% extends 'base.html' %}

{% block title %}仪表盘{% endblock %}

{% block content %}
    <h1 class="mt-4">仪表盘</h1>
    <p class="lead">系统概览和数据统计</p>
    <hr>

    <!-- 统计卡片 -->
    <div class="row">
        <div class="col-md-3">
            <div class="card text-white bg-primary mb-3 stats-card">
                <div class="card-body">
                    <h5 class="card-title">数据源总数</h5>
                    <h2 class="card-text">{{ total_sources }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success mb-3 stats-card">
                <div class="card-body">
                    <h5 class="card-title">爬取数据量</h5>
                    <h2 class="card-text">{{ total_crawled_data }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning mb-3 stats-card">
                <div class="card-body">
                    <h5 class="card-title">分析结果数</h5>
                    <h2 class="card-text">{{ total_analysis_results }}</h2>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-info mb-3 stats-card">
                <div class="card-body">
                    <h5 class="card-title">总任务数</h5>
                    <h2 class="card-text">{{ task_status.pending + task_status.running + task_status.completed + task_status.failed }}</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务状态 -->
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>任务状态</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-secondary p-3 mb-2">{{ task_status.pending }}</div>
                                <p class="text-muted">待处理</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-primary p-3 mb-2">{{ task_status.running }}</div>
                                <p class="text-muted">运行中</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-success p-3 mb-2">{{ task_status.completed }}</div>
                                <p class="text-muted">已完成</p>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="text-center">
                                <div class="badge bg-danger p-3 mb-2">{{ task_status.failed }}</div>
                                <p class="text-muted">已失败</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 最近数据 -->
    <div class="row">
        <!-- 最近数据源 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>最近数据源</h5>
                </div>
                <div class="card-body">
                    {% if recent_sources %}
                    <ul class="list-group">
                        {% for source in recent_sources %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ source.name }}
                            <span class="badge bg-info">{{ source.type }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">暂无数据源</p>
                    {% endif %}
                    <a href="{{ url_for('crawler.index') }}" class="btn btn-sm btn-primary mt-3">查看所有数据源</a>
                </div>
            </div>
        </div>

        <!-- 最近爬取数据 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>最近爬取数据</h5>
                </div>
                <div class="card-body">
                    {% if recent_crawled_data %}
                    <ul class="list-group">
                        {% for data in recent_crawled_data %}
                        <li class="list-group-item">
                            <small class="text-muted">{{ data.crawled_at.strftime('%Y-%m-%d %H:%M') }}</small><br>
                            {{ data.title[:30] }}{% if data.title|length > 30 %}...{% endif %}
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">暂无爬取数据</p>
                    {% endif %}
                    <a href="{{ url_for('crawler.index') }}" class="btn btn-sm btn-primary mt-3">查看所有爬取数据</a>
                </div>
            </div>
        </div>

        <!-- 最近分析结果 -->
        <div class="col-md-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5>最近分析结果</h5>
                </div>
                <div class="card-body">
                    {% if recent_analysis_results %}
                    <ul class="list-group">
                        {% for result in recent_analysis_results %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            {{ result.name }}
                            <span class="badge bg-warning">{{ result.type }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <p class="text-muted">暂无分析结果</p>
                    {% endif %}
                    <a href="{{ url_for('analyzer.results') }}" class="btn btn-sm btn-primary mt-3">查看所有分析结果</a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}