{% extends 'base.html' %}

{% block title %}数据分析{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>数据分析</h1>
    </div>

    <div class="card mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="card-title mb-0">数据统计</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="card-title text-primary">{{ total_sources }}</h3>
                            <p class="card-text">数据源总数</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="card-title text-success">{{ total_data }}</h3>
                            <p class="card-text">抓取数据总数</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body">
                            <h3 class="card-title text-info">{{ total_analysis }}</h3>
                            <p class="card-text">分析结果总数</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="card-title mb-0">数据清洗</h5>
                </div>
                <div class="card-body">
                    <h6>数据清洗选项</h6>
                    <form method="POST" action="{{ url_for('analyzer.clean_data') }}">
                        <div class="mb-3">
                            <label for="data_source" class="form-label">选择数据源</label>
                            <select class="form-select" id="data_source" name="data_source" required>
                                <option value="">-- 全部数据源 --</option>
                                {% for source in data_sources %}
                                <option value="{{ source.id }}">{{ source.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-check-label">清洗选项</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="remove_duplicates" name="remove_duplicates" checked>
                                <label class="form-check-label" for="remove_duplicates">
                                    移除重复数据
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="remove_empty" name="remove_empty" checked>
                                <label class="form-check-label" for="remove_empty">
                                    移除空内容
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="normalize_text" name="normalize_text" checked>
                                <label class="form-check-label" for="normalize_text">
                                    文本标准化
                                </label>
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-success">开始清洗</button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">数据分析</h5>
                </div>
                <div class="card-body">
                    <h6>数据分析选项</h6>
                    <form method="POST" action="{{ url_for('analyzer.analyze_data') }}">
                        <div class="mb-3">
                            <label for="analysis_data_source" class="form-label">选择数据源</label>
                            <select class="form-select" id="analysis_data_source" name="data_source" required>
                                <option value="">-- 全部数据源 --</option>
                                {% for source in data_sources %}
                                <option value="{{ source.id }}">{{ source.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="analysis_type" class="form-label">分析类型</label>
                            <select class="form-select" id="analysis_type" name="analysis_type" required>
                                <option value="basic_stats">基础统计分析</option>
                                <option value="text_analysis">文本分析</option>
                                <option value="sentiment_analysis">情感分析</option>
                                <option value="topic_modeling">主题建模</option>
                                <option value="classification">分类分析</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-info">开始分析</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    {% if analysis_results %}
    <div class="card mb-4">
        <div class="card-header bg-secondary text-white">
            <h5 class="card-title mb-0">最近分析结果</h5>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="thead-dark">
                        <tr>
                            <th>分析类型</th>
                            <th>数据源</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for result in analysis_results %}
                        <tr>
                            <td>{{ result.analysis_type }}</td>
                            <td>{{ result.source.name if result.source else '全部' }}</td>
                            <td>{{ result.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#analysisModal-{{ result.id }}">
                                    <i class="fa fa-eye" aria-hidden="true"></i> 查看结果
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- 分析结果模态框 -->
    {% for result in analysis_results %}
    <div class="modal fade" id="analysisModal-{{ result.id }}" tabindex="-1" aria-labelledby="analysisModalLabel-{{ result.id }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="analysisModalLabel-{{ result.id }}">{{ result.analysis_type }} 结果</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <h6><strong>分析类型：</strong></h6>
                        <p>{{ result.analysis_type }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6><strong>数据源：</strong></h6>
                        <p>{{ result.source.name if result.source else '全部数据源' }}</p>
                    </div>
                    
                    <div class="mb-3">
                        <h6><strong>分析结果：</strong></h6>
                        <pre class="bg-light p-3 rounded">{{ result.result }}</pre>
                    </div>
                    
                    <div class="mb-3">
                        <h6><strong>创建时间：</strong></h6>
                        <p>{{ result.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
{% endblock %}